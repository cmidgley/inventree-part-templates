{% comment %}
    Inspect frame template for the 'interactive' style of inspect for inventree-part-template plugin  

    Copyright (c) 2024 Chris Midgley
    License: MIT (see LICENSE file)

    This template is used to prepare the rendering of an object from inspect (such as the explore
    filter).  It is usually used to set up style and layout for the rendering, but then delegates to
    the object template for recursive rendering of the object and it's children.

    The following context variables are available:
    - inspect: contains information about the object to render.  See the object template(s) for
      details, as usually this information is not used in this parent template.
    - object_template: the name of the child template to load for rendering the object and it's
    children.  Include the template name using `{% include object_template with object=inspect %}`.
    - first_inspection: True if the first time this template has been used in the report.
{% endcomment %}

{% load inventree_extras %}

{% if first_inspection %}
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/brands.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/solid.min.css">

<style>
.inspect-interactive-outer {
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px;
    border-radius: 5px;
    background-color: #f9f9f9;
}
.inspect-interactive-item-title-title {
  font-weight: bold;
}
.inspect-interactive-item-title-title button {
  width: 24px;
}
button:not(.collapsed) .inspect-interactive-item-title-postfix {
  display: none;
}
.inspect-interactive-item-children {
    margin-left: 20px;
}
</style>
{% endif %}

<div class="inspect-interactive-outer">
{% include object_template with object=inspect %}
</div>

{% if first_inspection %}
<!-- bootstrap -->
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- fontawesome -->
<script defer type='text/javascript' src="/static/fontawesome/js/solid.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/regular.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/brands.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/fontawesome.min.js"></script>

<!-- toggle icon expand/collapse-->
<script>
  document.addEventListener('DOMContentLoaded', function () {
      var collapseElements = document.querySelectorAll('.collapse');
      collapseElements.forEach(function(collapseElement) {
          var button = document.querySelector('[data-bs-target="#' + collapseElement.id + '"]');
          var icon = button.querySelector('.expando-icon');
  
          collapseElement.addEventListener('show.bs.collapse', function () {
              icon.classList.remove('fa-caret-right');
              icon.classList.add('fa-caret-down');
          });
  
          collapseElement.addEventListener('hide.bs.collapse', function () {
              icon.classList.remove('fa-caret-down');
              icon.classList.add('fa-caret-right');
          });
      });
  });
  </script>

  # logic to watch for hash changes and expand the element to be visible
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        function expandToHash(hash) {
            if (!hash) return;
            
            // Find the element
            var target = document.getElementById(hash.slice(1));
            if (!target) return;
    
            // Find all parents that are collapsible
            var parents = [];
            var element = target;
            while (element) {
                if (element.matches('.collapse')) {
                    parents.push(element);
                }
                element = element.parentElement;
            }
    
            // Expand all parents
            parents.forEach(function(parent) {
                var bootstrapCollapse = new bootstrap.Collapse(parent, {
                    toggle: false // Do not toggle, just ensure it's open
                });
                bootstrapCollapse.show();
            });
    
            // Optionally, scroll to the target element
            setTimeout(function() {
                target.scrollIntoView({behavior: "smooth", block: "start"});
            }, 300); // Adjust timing based on your needs
        }
    
        // Run on load
        expandToHash(window.location.hash);
    
        // Run on hash change
        window.addEventListener('hashchange', function() {
            expandToHash(window.location.hash);
        }, false);
    });
  </script>
  
{% endif %}
