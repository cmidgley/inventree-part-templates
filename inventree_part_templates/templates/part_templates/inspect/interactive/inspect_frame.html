{% comment %}
    Inspect frame template for the 'interactive' style of inspect for inventree-part-template plugin  

    Copyright (c) 2024 Chris Midgley
    License: MIT (see LICENSE file)

    This template is used to prepare the rendering of an object from inspect (such as the explore
    filter).  It is usually used to set up style and layout for the rendering, but then delegates to
    the object template for recursive rendering of the object and it's children.

    The following context variables are available:
    - inspect: contains information about the object to render.  See the object template(s) for
      details, as usually this information is not used in this parent template.
    - object_template: the name of the child template to load for rendering the object and it's
    children.  Include the template name using `{% include object_template with object=inspect %}`.
    - first_inspection: True if the first time this template has been used in the report.
{% endcomment %}

{% load inventree_extras %}

{% if first_inspection %}
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/brands.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/solid.min.css">

<style>
.inspect-interactive-outer {
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px;
    border-radius: 5px;
    background-color: #f9f9f9;
}
.inspect-interactive-item-title-title {
  font-weight: bold;
}
.inspect-interactive-item-title-title button {
  width: 24px;
}
button:not(.collapsed) .inspect-interactive-item-title-postfix {
  display: none;
}
.inspect-interactive-item-children {
    margin-left: 20px;
}
</style>
{% endif %}

<div class="inspect-interactive-outer">
{% include object_template with object=inspect %}
</div>

{% if first_inspection %}
<!-- bootstrap -->
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- fontawesome -->
<script defer type='text/javascript' src="/static/fontawesome/js/solid.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/regular.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/brands.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/fontawesome.min.js"></script>

<!-- toggle icon expand/collapse, and collapse children when parent collapsed -->
<script>
  $(document).ready(function () {
    $('.collapse').each(function() {
      var collapseElement = $(this);
      var button = $('[data-bs-target="#' + collapseElement.attr('id') + '"]');
      var icon = button.find('.expando-icon');
  
      // on expand, change the icon to a down arrow
      collapseElement.on('show.bs.collapse', function () {
        icon.removeClass('fa-caret-right').addClass('fa-caret-down');
      });
  
      // on collapse, change the icon to a right arrow and collapse all children
      collapseElement.on('hide.bs.collapse', function () {
        icon.removeClass('fa-caret-down').addClass('fa-caret-right');
  
        // collapse all child collapse elements
        collapseElement.find('.collapse.show').each(function() {
          $(this).collapse('hide');
          // update child icons as well
          var childIcon = $('[data-bs-target="#' + $(this).attr('id') + '"]').find('.expando-icon');
          childIcon.removeClass('fa-caret-down').addClass('fa-caret-right');
        });
      });
    });
  });
</script>
  
<!-- logic to watch for hash changes and expand the element to be visible -->
<script>
  $(document).ready(function() {
    function expandToHash(hash) {
      if (!hash) return;
        
      // find the target element
      var target = $('#' + hash.slice(1));
      if (target.length === 0) return;

      // collect all collapsible parents
      var parents = target.parents('.collapse');

      // expand all parents 
      parents.each(function() {
        $(this).collapse('show');
      });

      // scroll to the target element
      setTimeout(function() {
        target[0].scrollIntoView({behavior: "smooth", block: "start"});
      }, 300);
    }

    // run on load with the current hash
    expandToHash(window.location.hash);

    // attach an event listener for hash changes
    $(window).on('hashchange', function() {
      expandToHash(window.location.hash);
    });
  });
</script>
    
{% endif %}
