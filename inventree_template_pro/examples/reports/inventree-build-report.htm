{% extends "report/inventree_report_base.html" %}

{% load i18n %}
{% load report %}
{% load barcode %}
{% load inventree_extras %}
{% load markdownify %}
{% load template_pro %}

{% block page_margin %}
margin: 2cm;
margin-top: 4cm;
{% endblock page_margin %}

{% block style %}

.header-right {
    text-align: right;
    float: right;
}

tr {
    page-break-inside: avoid;
}

.logo {
    height: 20mm;
    vertical-align: middle;
}

.part-image {
    border: 1px solid;
    border-radius: 2px;
    vertical-align: middle;
    height: 40mm;
    max-width: 100%;
    display: inline-block;
    z-index: 100;
}

.details-image {
    float: right;
    width: 30%;
}

.details {
    width: 100%;
    border: 1px solid;
    border-radius: 3px;
    padding: 5px;
    min-height: 42mm;
}

.details table {
    overflow-wrap: break-word;
    word-wrap: break-word;
    width: 65%;
    table-layout: fixed;
    font-size: 75%;
}

.details table td:not(:last-child){
    white-space: nowrap;
}

.details table td:last-child{
    width: 50%;
    padding-left: 1cm;
    padding-right: 1cm;
}

.details-table td {
    padding-left: 10px;
    padding-top: 5px;
    padding-bottom: 5px;
    border-bottom: 1px solid #555;
}

.table-materials {
    text-align: left;
    width: 100%;
    padding-top: 10px;
    font-size: 75%;
}

.table-materials td {
    vertical-align: top;
}

.col-quantity {
    text-align: center;
    width: 100px;
}

.col-category {
    width: 180px;
}

.col-part {
}

.col-part-thumb {
    max-width: 32px;
    max-height: 32px;
    display: inline;
}

.col-part-text {
    display: block;
}

.col-part-description {
    display: block;
    font-weight: bold;
}

.col-stock {
    width: 300px;
}

.col-reference {
    overflow-wrap: break-word;
    white-space: normal;
}

.error {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12pt;
    color: red;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
{% endblock style %}

{% block bottom_left %}
content: "v{{ report_revision }} - {{ date.isoformat }}";
{% endblock bottom_left %}

{% block header_content %}
    <img class='logo' src="{% logo_image %}" alt="logo" width="150">

    <div class='header-right'>
        <h3>
            Build Order {{ build }}
        </h3>
        <small>{{ quantity }} x {{ part.full_name }}</small>
        <br>
    </div>

    <hr>
{% endblock header_content %}

{% block page_content %}

<div class='details'>
    <div class='details-image'>
        <img class='part-image' alt="{% trans 'Part image' %}" src="{% part_image part height=480 %}">
    </div>

    <div class='details-container'>

        <table class='details-table'>
            <tr>
                <th>{% trans "Build Order" %}</th>
                <td>{% internal_link build.get_absolute_url build %}</td>
            </tr>
            <tr>
                <th>{% trans "Part" %}</th>
                <td>{% internal_link part.get_absolute_url part.full_name %}</td>
            </tr>
            <tr>
                <th>{% trans "Quantity" %}</th>
                <td>{{ build.quantity }}</td>
            </tr>
            <tr>
                <th>{% trans "Description" %}</th>
                <td>{{ build.title }}</td>
            </tr>
            <tr>
                <th>{% trans "Issued" %}</th>
                <td>{{ build.creation_date.isodate }}</td>
            </tr>
            <tr>
                <th>{% trans "Target Date" %}</th>
                <td>
                    {% if build.target_date %}
                    {{ build.target_date.isodate }}
                    {% else %}
                    <em>{% trans "Not specified" %}</em>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>{% trans "Sales Order" %}</th>
                <td>
                    {% if build.sales_order %}
                    {% internal_link build.sales_order.get_absolute_url build.sales_order %}
                    {% else %}
                    <em>{% trans "Not specified" %}</em>
                    {% endif %}
                </td>
            </tr>
            {% if build.parent %}
            <tr>
                <th>{% trans "Required For" %}</th>
                <td>{% internal_link build.parent.get_absolute_url build.parent %}</td>
            </tr>
            {% endif %}
            {% if build.issued_by %}
            <tr>
                <th>{% trans "Issued By" %}</th>
                <td>{{ build.issued_by }}</td>
            </tr>
            {% endif %}
            {% if build.responsible %}
            <tr>
                <th>{% trans "Responsible" %}</th>
                <td>{{ build.responsible }}</td>
            </tr>
            {% endif %}
            {% if build.link %}
            <tr>
                <th>{% trans "Link" %}</th>
                <td><a href="{{ build.link }}">{{ build.link }}</a></td>
            </tr>
            {% endif %}
        </table>
    </div>
</div>

<br>

<br>
{% if build.notes %}
<h3>{% trans "Notes" %}</h3>
{{ build.notes|markdownify }}
<hr>
{% endif %}

<table class='table table-striped table-condensed table-materials'>
    <thead>
        <tr>
            <th class="col-quantity">{% trans "Quantity" %}</th>
            <th class="col-category">{% trans "Category" %}</th>
            <th class="col-part">{% trans "Part" %}</th>
            <th class="col-stock">{% trans "Stock" %}</th>
            <th class="col-reference">{% trans "Reference(s)" %}</th>
        </tr>
    </thead>
    <tbody>

{% call part "getRequiredParts" True None as required_parts %}
{% for required_part in required_parts %}
    {% part_context required_part.pk as part_context %}
    {% if not part_context %}
        <tr>
            <td colspan="5" class="error">{% trans "Plugin inventree-template-pro did not locate part:" %} {{line.sub_part.pk }}</td>
        </tr>
    {% elif part_context.error %}
        <tr>
            <td colspan="5" class="error">{{ part_context.error }}</td>
        </tr>
    {% else %}
            <td class="col-quantity">
                {{ required_part.used_in_count }}
            </td>
            <td class="col-category">
                {{ part_context.category }}
            </td>
            <td class="col-part">
                <table>
                    <tr>
                        <td>
                            <img src='{% part_image required_part height=240 %}' alt='{% trans "Image" %}' class='col-part-thumb'>
                        </td>
                        <td>
                            <div class='col-part-text'>
                                {{ required_part.full_name }}
                            </div>
                            <div class='col-part-description'>
                                {{ part_context.description }}
                            </div>        
                        </td>
                    </tr>
                </table>
            </td>
            <td class="col-stock">
                <div class="col-stock-available">
                    <span class="col-stock-available-quantity">{{ required_part.total_stock|floatformat:"0" }} 
                        {% trans "on-hand" %}</span>
                    {% if required_part.on_order > 0 %}
                        {% blocktrans with on_order=required_part.on_order %}
                            ({{ on_order }} on order)
                        {% endblocktrans %}
                    {% endif %}
                </div>
                <div class="col-stock-pricing">
                    {% blocktrans with min=required_part.pricing.overall_min max=required_part.pricing.overall_max %}
                        {{ min }} - {{ max }}
                    {% endblocktrans %}
                </div>
                <div class="col-stock-location">
                    {% for build_item in required_part.build_order_allocations %}
                        {% if build_item.build.pk == build.pk %}
                            {% if build_item.stock_item.location %}
                                {{ build_item.stock_item.location.description }}
                                {% if build_item.stock_item.location_type %}
                                    {% blocktrans with type=build_item.stock_item.location_type %}
                                        (type {{ type }})
                                    {% endblocktrans %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </td>
            <td class="col-reference">
                {% for build_item in part.get_bom_items %}
                    {% if required_part.pk == build_item.sub_part_id %}
                        {{ build_item.reference|replace:",|, " }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
    {% endif %}
{% endfor %}
</tbody>
</table>

{% endblock page_content %}