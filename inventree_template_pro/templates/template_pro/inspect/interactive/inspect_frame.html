{% comment %}
    Inspect frame template for the 'interactive' style of inspect for inventree-template-pro plugin  

    Copyright (c) 2024 Chris Midgley
    License: MIT (see LICENSE file)

    This template is used to prepare the rendering of an object from inspect (such as the explore
    filter).  It is usually used to set up style and layout for the rendering, but then delegates to
    the object template for recursive rendering of the object and it's children.

    The following context variables are available:
    - inspect: contains information about the object to render.  See the object template(s) for
      details, as usually this information is not used in this parent template.
    - object_template: the name of the child template to load for rendering the object and it's
    children.  Include the template name using `{% include object_template with object=inspect %}`.
    - first_inspection: True if the first time this template has been used in the report.
{% endcomment %}

{% load inventree_extras %}

{% if first_inspection %}
<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/brands.min.css">
<link rel="stylesheet" href="/static/fontawesome/css/solid.min.css">

<style>
.inspect-interactive-outer {
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px;
    border-radius: 5px;
    background-color: #f9f9f9;
}
.inspect-interactive-item-title-title {
  font-weight: bold;
}
.inspect-interactive-item-title-title button {
  width: 24px;
}
button:not(.collapsed) .inspect-interactive-item-title-postfix {
  display: none;
}
.inspect-interactive-item-children {
    margin-left: 20px;
}
</style>
{% endif %}

<div class="inspect-interactive-outer">
{% include object_template with object=inspect %}
</div>

{% if first_inspection %}
<!-- bootstrap -->
<script type="text/javascript" src="/static/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- fontawesome -->
<script defer type='text/javascript' src="/static/fontawesome/js/solid.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/regular.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/brands.min.js"></script>
<script defer type='text/javascript' src="/static/fontawesome/js/fontawesome.min.js"></script>

<!-- toggle icon expand/collapse, and collapse children when parent collapsed -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.collapse').forEach(function(collapseElement) {
      var button = document.querySelector('[data-bs-target="#' + collapseElement.id + '"]');
      var icon = button.querySelector('.expando-icon');
      
      // Event listener for expand
      collapseElement.addEventListener('show.bs.collapse', function() {
        icon.classList.remove('fa-caret-right');
        icon.classList.add('fa-caret-down');
      });
      
      // Event listener for collapse
      collapseElement.addEventListener('hide.bs.collapse', function(event) {
        // Stop collapse event from bubbling up
        event.stopPropagation();
        
        // change the icon to show collapsed
        icon.classList.remove('fa-caret-down');
        icon.classList.add('fa-caret-right');
        
        // Manually hide all child collapse elements
        collapseElement.querySelectorAll('.collapse.show').forEach(function(childCollapse) {
          childCollapse.classList.remove('show');
          childCollapse.style.height = '0'; // Mimic Bootstrap's hiding behavior

          // Update child icons as well
          var childIcon = document.querySelector('[data-bs-target="#' + childCollapse.id + '"] .expando-icon');
          childIcon.classList.remove('fa-caret-down');
          childIcon.classList.add('fa-caret-right');
        });
      });
    });
  });
  </script>
    
<!-- logic to watch for hash changes and expand the element to be visible -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    function expandToHash(hash) {
      if (!hash) return;

      // Find the target element using native JavaScript
      var target = document.getElementById(hash.slice(1));
      if (!target) return;

      // Collect all collapsible parents using closest and accumulating them
      var parents = [];
      var element = target;
      while (element) {
        element = element.closest('.collapse');
        if (element) {
          parents.push(element);
          element = element.parentElement;  // continue searching from the parent
        }
      }

      // Expand all parents
      parents.forEach(function(parent) {
        var bsCollapse = new bootstrap.Collapse(parent, {
          toggle: false
        });
        bsCollapse.show();
      });

      // Scroll to the target element
      setTimeout(function() {
        target.scrollIntoView({behavior: "smooth", block: "start"});
      }, 300);
    }

    // Run on load with the current hash
    expandToHash(window.location.hash);

    // Attach an event listener for hash changes
    window.addEventListener('hashchange', function() {
      expandToHash(window.location.hash);
    });
  });
</script>

    
{% endif %}
